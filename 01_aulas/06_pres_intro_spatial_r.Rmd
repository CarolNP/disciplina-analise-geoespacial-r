---
title: "Introdução à análise geoespacial com R <br><br><br>"
subtitle: "6 Estrutura e manejo de dados vetoriais <br><br><br>"
author: "Maurício H. Vancine <br> Milton C. Ribeiro"
date: "22/10/2020"
output:
  xaringan::moon_reader:
    css: [metropolis, metropolis-fonts]
    lib_dir: libs
    nature:
      highlightStyle: rainbow
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE, encoding = "UTF-8")
knitr::opts_chunk$set(fig.retina = 3, warning = FALSE, message = FALSE)
if(!require(emo)) devtools::install_github("hadley/emo")
```

class: clear
background-image: url(img/geo_vector_sf_allison.png)
background-size: 800px

---

background-image: url(img/r_spatial.jpeg)
background-size: 350px
background-position: 90% 85%

# 6 Estrutura e manejo de dados vetoriais

## Tópicos
1. Pacote sf
1. Geometrias sf
1. Classes sf
1. Importar dados
1. Converter dados sf
1. Descrição de objetos sf
1. Conversão do CRS
1. Tabela de atributos
1. Operações de atributos
1. Operações geométricas
1. Operações espaciais
1. Exportar dados

---

background-image: url(img/package_sf.gif)
background-size: 350px
background-position: 50% 90%

# 6.1 Pacote sf

## sf

```{r eval=FALSE}
# sf
install.packages("sf")
```

```{r}
library(sf)
```

---

background-image: url(img/geo_sf_article.png)
background-size: 500px
background-position: 50% 60%

# 6.1 Pacote sf

## Simple Features for R: Standardized Support for Spatial Vector Data

#### Edzer Pebesma

<br><br><br><br><br><br><br><br><br><br><br>

[*] https://journal.r-project.org/archive/2018/RJ-2018-009/RJ-2018-009.pdf

---

# 6.1 Pacote sf

## sf

### **Rápida importação e exportação** de dados

--

### **Desempenho aprimorado** de mapas e gráficos

--

### Objetos `sf` podem ser tratados como `data frames` (`tibbles`) na maioria das **operações de manejo**

--

### As funções `sf` **podem ser combinadas** usando o operador `%>%` e funcionam bem com `tidyverse`

--

### Os nomes das funções sf são relativamente **consistentes e intuitivos** (todos começam com `sf::st_`)

---

background-image: url(img/geo_vector_sf_types.png)
background-size: 450px
background-position: 50% 60%

# 6.2 Tipos de geometrias sf

## Tipos de geometrias

---

# 6.3 Classes sf

## Simple feature geometries (sfg)

### A classe `sfg` representa os diferentes tipos de geometrias no R: ponto, linha, polígono (e seus equivalentes ‘multi’) ou coleção de geometrias

--

### Funções para criar geometrias da classe `sfg`:

```{r eval=FALSE}
sf::st_point()
sf::st_linestring()
sf::st_polygon()
sf::st_multipoint()
sf::st_multilinestring()
sf::st_multipolygon()
sf::st_geometrycollection()
```

---

# 6.3 Classes sf

## Simple feature geometries (sfg)

### Os objetos `sfg` podem ser criados a partir de três tipos de dados R base:

<br><br>

#### 1. **vetor numérico**: um único ponto
#### 2. **matriz**: um conjunto de pontos, onde cada linha representa um ponto, um multiponto ou uma linha
#### 3. **lista**: uma coleção de objetos como matrizes, cadeias multilinha ou coleções de geometrias

---

# 6.3 Classes sf

## Simple feature geometries (sfg)

```{r}
# vector - point
vec <- c(5, 2)
po <- sf::st_point(vec)
po
```

```{r fig.align='center', out.width='35%'}
# vector - point
plot(po, pch = 20, cex = 4, axes = TRUE, graticule = TRUE)
```

---

# 6.3 Classes sf

## Simple feature geometries (sfg)

```{r}
# matrix - multipoint
multipoint_matrix = rbind(c(5, 2), c(1, 3), c(3, 4), c(3, 2))
po_mul <- sf::st_multipoint(multipoint_matrix)
po_mul
```

```{r fig.align='center', out.width='35%'}
# matrix - multipoint
plot(po_mul, pch = 20, cex = 4, axes = TRUE, graticule = TRUE)
```

---

# 6.3 Classes sf

## Simple feature geometries (sfg)

```{r}
# matrix - multipoint
multipoint_matrix = rbind(c(5, 2), c(1, 3), c(3, 4), c(3, 2))
lin <- sf::st_linestring(multipoint_matrix)
lin
```

```{r fig.align='center', out.width='35%'}
# matrix - multipoint
plot(lin, lwd = 2, axes = TRUE, graticule = TRUE)
```

---

# 6.3 Classes sf

## Simple feature geometries (sfg)

```{r}
# list - polygon
polygon_list = list(rbind(c(1, 5), c(2, 2), c(4, 1), c(4, 4), c(1, 5)))
pol <- sf::st_polygon(polygon_list)
pol
```

```{r fig.align='center', out.width='35%'}
# list - polygon
plot(pol, col = "gray", axes = TRUE, graticule = TRUE)
```

---

# 6.3 Classes sf

## Simple feature columns (sfc)

### Uma **lista de objetos** `sfg` que possui o **mesmo CSR** (Coordinate Reference System)

--

### Pode conter objetos da **mesma geometria** ou de **geometrias diferentes**

--

### Funções para **criar** a classe `sfc` e verificar o **tipo da geometria e CRS**:
```{r eval=FALSE}
sf::st_sfc()
sf::st_geometry_type()
sf::st_crs()
```

---

# 6.3 Classes sf

## Simple feature columns (sfc)
```{r}
# sfc POINT
point1 <- sf::st_point(c(5, 2))
point2 <- sf::st_point(c(1, 3))
points_sfc <- sf::st_sfc(point1, point2)
points_sfc
```

```{r}
sf::st_geometry_type(points_sfc)
```

---

# 6.3 Classes sf

## Simple feature columns (sfc)

### Plot
```{r fig.align='center', out.width='45%'}
plot(points_sfc, pch = 20, cex = 4, axes = TRUE, graticule = TRUE)
```

---

# 6.3 Classes sf

## Simple feature columns (sfc)
```{r}
# sfc GEOMETRY
po_pol_sfc <- sf::st_sfc(po, pol)
po_pol_sfc
```

```{r}
sf::st_geometry_type(po_pol_sfc)
```

---

# 6.3 Classes sf

## Simple feature columns (sfc)

### Plot
```{r fig.align='center', out.width='45%'}
plot(po_pol_sfc, pch = 20, cex = 4, lwd = 2, col = "gray", axes = TRUE, graticule = TRUE)
```

---

# 6.3 Classes sf

## Simple feature columns (sfc)

### Coordinate Reference Systems (CRS) - EPSG
```{r}
# EPSG definition
points_sfc_wgs <- sf::st_sfc(point1, point2, crs = 4326)
sf::st_crs(points_sfc_wgs)
```

---

# 6.3 Classes sf

## Simple feature columns (sfc)

### Coordinate Reference Systems (CRS) - proj4string
```{r}
# EPSG definition
points_sfc_wgs <- sf::st_sfc(point1, point2, crs = "+proj=longlat +datum=WGS84 +no_defs")
sf::st_crs(points_sfc_wgs)
```

---

# 6.3 Classes sf

## Simple feature columns (sfc)

### Plot
```{r fig.align='center', out.width='45%'}
plot(points_sfc_wgs, pch = 20, cex = 4, axes = TRUE, graticule = TRUE)
```

---

# 6.3 Classes sf

## A classe sf

### A classe sf (simple features) são **data.frames** com **atributos espaciais** armazenados em uma coluna, geralmente chamada de **geometry** 

--

### Essa **dualidade** é central para o conceito de **simple features**: na maioria das vezes, um sf pode **ser tratado e se comporta** como um data.frame 

--

### **Simple features** são, em essência, **data.frames** com uma **extensão espacial**

---

# 6.3 Classes sf

## A classe sf

### Criar um objeto sf
```{r}
rc_point <- sf::st_point(c(-47.57,-22.39))         # sfg object
rc_geom <- sf::st_sfc(rc_point, crs = 4326)        # sfc object
rc_attrib <- data.frame(                       # data.frame object
  name = "Rio Claro",
  temperature = 19,
  date = as.Date("2020-10-13")
)
rc_sf <- sf::st_sf(rc_attrib, geometry = rc_geom)  # sf object
```

---

# 6.3 Classes sf

## A classe sf

### A estrutura de um objeto sf
```{r}
rc_sf
```

### As duas classes do objeto sf
```{r}
class(rc_sf)
```

---

# 6.3 Classes sf

## A classe sf

### Plot
```{r fig.align='center', out.width='45%'}
plot(rc_sf[1], pch = 20, cex = 4, axes = TRUE, graticule = TRUE) # rc_sf[1] - plotar a primeira coluna
```

---

# 6.3 Classes sf

## A classe sf

### Plot
```{r fig.align='center', out.width='45%'}
plot(rc_sf[2], pch = 20, cex = 4, axes = TRUE, graticule = TRUE) # rc_sf[2] - plotar a segunda coluna
```

---

# 6.3 Classes sf

## A classe sf

### Plot
```{r fig.align='center', out.width='45%'}
plot(rc_sf$geom, pch = 20, cex = 4, axes = TRUE, graticule = TRUE) # rc_sf$geom - plotar apenas a geometria
```

---

class: inverse, center, middle

# Dúvidas?

---

class: inverse, center, middle

# Vamos começar fazendo o download de vetores pelo R

---

# 6.4 Importar dados

## Download

### Criar um diretório 
```{r eval=FALSE}
# create a diretorio
dir.create(here::here("03_dados", "vetor"))
```

--

### Download de **pontos de nascentes** para Rio Claro/SP
```{r eval=FALSE}
# download
for(i in c(".dbf", ".prj", ".shp", ".shx")){
  download.file(url = paste0("http://geo.fbds.org.br/SP/RIO_CLARO/HIDROGRAFIA/SP_3543907_NASCENTES", i),
                destfile = here::here("03_dados", "vetor", paste0("SP_3543907_NASCENTES", i)), mode = "wb")
}
```

---

# 6.4 Importar dados

## Download

### Download de **linhas da hidrografia** para Rio Claro/SP
```{r eval=FALSE}
# download
for(i in c(".dbf", ".prj", ".shp", ".shx")){
  download.file(url = paste0("http://geo.fbds.org.br/SP/RIO_CLARO/HIDROGRAFIA/SP_3543907_RIOS_SIMPLES", i),
                destfile = here::here("03_dados", "vetor", paste0("SP_3543907_RIOS_SIMPLES", i)), mode = "wb")
}
```

### Download de **polígonos de cobertura da terra** para Rio Claro/SP
```{r eval=FALSE}
# download
for(i in c(".dbf", ".prj", ".shp", ".shx")){
  download.file(url = paste0("http://geo.fbds.org.br/SP/RIO_CLARO/USO/SP_3543907_USO", i),
                destfile = here::here("03_dados", "vetor", paste0("SP_3543907_USO", i)), mode = "wb")
}
```

---

class: inverse, center, middle

# Importar dados preexistentes

---

# 6.4 Importar dados

## Dados preexistentes
```{r}
# import
rc_spr <- sf::st_read(here::here("03_dados", "vetor", "SP_3543907_NASCENTES.shp"), quiet = TRUE)
rc_spr
```

---

# 6.4 Importar dados

## Dados preexistentes
```{r fig.align='center', out.width='50%'}
plot(rc_spr$geom, pch = 20, col = "blue", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados preexistentes
```{r}
# import
rc_riv <- sf::st_read(here::here("03_dados", "vetor", "SP_3543907_RIOS_SIMPLES.shp"), quiet = TRUE)
rc_riv
```

---

# 6.4 Importar dados

## Dados preexistentes
```{r fig.align='center', out.width='50%'}
plot(rc_riv$geom, col = "steelblue", main = NA, axes = TRUE, graticule = TRUE)
```
---

# 6.4 Importar dados

## Dados preexistentes
```{r cache=TRUE}
# import
rc_use <- sf::st_read(here::here("03_dados", "vetor", "SP_3543907_USO.shp"), quiet = TRUE)
rc_use
```

---

# 6.4 Importar dados

## Dados preexistentes
```{r fig.align='center', out.width='50%'}
plot(rc_use$CLASSE_USO, col = c("blue", "orange", "gray30", "forestgreen", "green"), main = NA, axes = TRUE, graticule = TRUE)
```

---

class: inverse, center, middle

# Importar dados de GPS

---

class: inverse, center, middle

# Um agradecimento ao Rafael (Urucum), que gentilmente cedeu os dados `r icon::fa_grin_beam_sweat()`

---

# 6.4 Importar dados

## Dados de GPS (.gpx)
```{r}
# import gps data
gps_gpx <- sf::read_sf(here::here("03_dados", "vetor", "waypoints.gpx"), layer = "waypoints")
gps_gpx
```

---

# 6.4 Importar dados

## Dados de uma planilha .csv
```{r fig.align='center', out.width='60%'}
# plot
plot(gps_gpx$geom, cex = 4, pch = 20, col = "red", main = NA, axes = TRUE, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados de GPS (.gpx)
```{r}
# import gps data
gps_kml <- sf::read_sf(here::here("03_dados", "vetor", "waypoints.kml"))
gps_kml
```

---

# 6.4 Importar dados

## Dados de uma planilha .csv
```{r fig.align='center', out.width='60%'}
# plot
plot(gps_kml$geom, cex = 4, pch = 20, col = "red", main = NA, axes = TRUE, graticule = TRUE)
```

---

class: inverse, center, middle

# Importar dados de pacotes

---

background-image: url(img/package_geobr02.png)
background-size: 300px
background-position: 50% 70%

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r eval=FALSE}
install.packages("geobr")
library(geobr)
```

<br><br><br><br><br><br><br><br><br><br><br>

[*] https://github.com/ipeaGIT/geobr

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r message=FALSE, warning=FALSE}
# brazil 2019
br_2019 <- geobr::read_country(year = 2019, showProgress = FALSE)
br_2019
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r fig.align='center', out.width='50%'}
# plot
plot(br_2019$geom, col = "gray", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r}
# brazil 1872
br_1872 <- geobr::read_country(year = 1872, showProgress = FALSE)
br_1872
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr

```{r fig.align='center', out.width='60%'}
# plot
plot(br_1872$geom, col = "gray", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r}
# sao paulo state
sp_2019 <- geobr::read_state(code_state = "SP", year = 2019, showProgress = FALSE)
sp_2019
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r fig.align='center', out.width='60%'}
# plot
plot(sp_2019$geom, col = "gray", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r}
# sao paulo municipalities
sp_mun_2019 <- geobr::read_municipality(code_muni = "SP", year = 2019, showProgress = FALSE)
sp_mun_2019
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r fig.align='center', out.width='60%'}
# plot
plot(sp_mun_2019$geom, col = "gray", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r}
# rio claro
rc_2019 <- geobr::read_municipality(code_muni = 3543907, year = 2019, showProgress = FALSE)
rc_2019
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r fig.align='center', out.width='50%'}
# plot
plot(rc_2019$geom, col = "gray", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r}
# biomes
bi_2019 <- geobr::read_biomes(year = 2019, showProgress = FALSE)
bi_2019
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr
```{r fig.align='center', out.width='50%'}
# plot
plot(bi_2019$geom, col = "gray", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados de pacotes: geobr

<br>

|Function|Geographies available|Years available|Source|
|-----|-----|-----|-----|
|`read_country()`| Country | 1872, 1900, 1911, 1920, 1933, 1940, 1950, 1960, 1970, 1980, 1991, 2000, 2001, 2010, 2013, 2014, 2015, 2016, 2017, 2018, 2019 | IBGE |
|`read_state()`| States | 1872, 1900, 1911, 1920, 1933, 1940, 1950, 1960, 1970, 1980, 1991, 2000, 2001, 2010, 2013, 2014, 2015, 2016, 2017, 2018, 2019 | IBGE |
|`read_municipality()`| Municipality | 1872, 1900, 1911, 1920, 1933, 1940, 1950, 1960, 1970, 1980, 1991, 2000, 2001, 2005, 2007, 2010, 2013, 2014, 2015, 2016, 2017, 2018, 2019 | IBGE | 
|`read_biomes()`| Biomes | 2004, 2019 | IBGE | 

---

# 6.4 Importar dados

## Dados de pacotes: geobr

```{r}
# list all datasets available in the geobr package
geobr::list_geobr()
```

---

background-image: url(img/package_ropensci.png)
background-size: 600px
background-position: 50% 60%

# 6.4 Importar dados

## Dados de pacotes: rnaturalearth
```{r eval=FALSE}
install.packages("rnaturalearth")
library(rnaturalearth)
```

<br><br><br><br><br><br><br><br><br><br>

[*] http://www.naturalearthdata.com/ 

[*] https://docs.ropensci.org/rnaturalearth/

---

# 6.4 Importar dados

## Dados de pacotes: rnaturalearth
```{r warning=FALSE}
# south america
sa <- rnaturalearth::ne_countries(scale = "small", continent = "South America", returnclass = "sf")
sa
```

---

# 6.4 Importar dados

## Dados de pacotes: rnaturalearth
```{r fig.align='center', fig.height = 4, out.width='80%'}
# plot
plot(sa$geom, col = "gray", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.4 Importar dados

## Dados de pacotes: rnaturalearth
```{r}
# coast lines
coastline <- rnaturalearth::ne_coastline(scale = "small", returnclass = "sf")
coastline
```

---

# 6.4 Importar dados

## Dados de pacotes: rnaturalearth
```{r fig.align='center', fig.height = 4, out.width='80%'}
# plot
plot(coastline$geom, col = "blue", main = NA, axes = TRUE, graticule = TRUE)
```

---

class: inverse, center, middle

# Importar dados de planilhas eletrônicas e converter em sf

---

# 6.5 Converter dados sf

## Dados de uma planilha eletrônica
```{r}
library(tidyverse)

# importar tabela
si <- readr::read_csv(here::here("03_dados", "ATLANTIC_AMPHIBIANS_sites.csv"))
```

---

# 6.5 Converter dados sf

## Add as duas colunas de `lon` e `lat`
```{r}
# .csv para .shp
si_ve <- si %>% 
  dplyr::mutate(lon = longitude, lat = latitude)
si_ve
```

---

class: inverse, center, middle

# Converter dados de planilhas em sf

---

# 6.5 Converter dados sf

## Converter dados de planilhas em sf
```{r}
# .csv para .shp
si_ve <- si %>% 
  dplyr::mutate(lon = longitude, lat = latitude) %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4326)
si_ve
```

---

# 6.5 Converter dados sf

## Converter dados de planilhas em sf
```{r, fig.align='center', out.width='50%'}
# plot
plot(si_ve$geom, pch = 20, main = NA, axes = TRUE, graticule = TRUE)
```

---

class: inverse, center, middle

# Converter dados de sp em sf

---

background-image: url(img/geo_sp.png)
background-size: 600px
background-position: 50% 60%

# 6.5 Converter dados sf

## Tipos de objetos sp
- SpatialPoints 
- SpatialLines
- SpatialPolygons
- SpatialPointsDataFrame
- SpatialLinesDataFrame
- SpatialPolygonsDataFrame

---

# 6.5 Converter dados sf

## sp
```{r warning=FALSE}
# countries
co110_sp <- rnaturalearth::countries110
co110_sp
```

---

# 6.5 Converter dados sf

## Converter `sp` para `sf`
```{r warning=FALSE}
# countries
co110_sf <- sf::st_as_sf(co110_sp)
co110_sf
```

---

# 6.5 Converter dados sf

## Dados de pacotes: rnaturalearth
```{r fig.align='center', fig.height = 4, out.width='80%'}
# plot
plot(co110_sf$geom, col = "gray", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.5 Converter dados sf

## Converter `sf` para `sp`
```{r warning=FALSE}
# countries
co110_sp <- sf::as_Spatial(co110_sf)
co110_sp
```

---

# 6.6 Descrição de objetos sf

## Informações geográficas e da tabela de atributos
```{r}
# rio claro 2019
rc_2019
```

---

# 6.6 Descrição de objetos sf

## Informações geográficas

### Bounding box
```{r}
# extention
sf::st_bbox(rc_2019)
```

--

### Coordinate reference system
```{r}
# coordinate reference system
sf::st_crs(rc_2019)
```

---

class: inverse, center, middle

# Conversão do CRS local

---

# 6.7 Conversão do CRS

## SIRGAS 2000 / UTM zone 23S -> WGS84 / UTM zone 23S
```{r}
rc_2019_utm_wgs84 <- sf::st_transform(rc_2019, crs = 32723)
rc_2019_utm_wgs84
```

[*] https://epsg.io/32723

---

# 6.7 Conversão do CRS

## SIRGAS 2000 / UTM zone 23S -> WGS84 / GCS
```{r}
rc_2019_gcs_wgs84 <- sf::st_transform(rc_2019, crs = 4326)
rc_2019_gcs_wgs84
```

[*] https://epsg.io/4326

---

# 6.7 Conversão do CRS

## SIRGAS 2000 / UTM zone 23S -> WGS84 / GCS
```{r echo=FALSE, fig.align='center'}
library(tidyverse)
p1 <- ggplot() +
  geom_sf(data = rc_2019_gcs_wgs84) +
  coord_sf(datum = sf::st_crs(4326)) +
  labs(x = "Longitude", y = "Latitude", title = "Geo - WGS84") + 
  theme_bw() +
  theme(panel.grid = element_line(size = .5, color = "black", linetype = 2))

p2 <- ggplot() +
  geom_sf(data = rc_2019) +
  coord_sf(datum = sf::st_crs(32723)) +
  labs(x = "x", y = "y", title = "UTM 23S - WGS84") + 
  theme_bw() +
  theme(panel.grid = element_line(size = .5, color = "black", linetype = 2))

gridExtra::grid.arrange(p1, p2, nrow = 1)
```

---

class: inverse, center, middle

# Conversão do CRS global

---

# 6.7 Conversão do CRS
```{r}
co110_sf
```

---

# 6.7 Conversão do CRS
```{r fig.align='center'}
plot(co110_sf$geom, axes = TRUE, graticule = TRUE)
```

---

# 6.7 Conversão do CRS

## Projeção de Mollweide
```{r}
co110_sf_moll <- sf::st_transform(co110_sf, crs = "+proj=moll")
co110_sf_moll
```

[*] https://epsg.io/54009

---

# 6.7 Conversão do CRS

## Projeção de Mollweide
```{r fig.align='center'}
plot(co110_sf_moll$geom, graticule = TRUE)
```

---

# 6.7 Conversão do CRS

## Projeção azimutal de Lambert
```{r}
co110_sf_lamb <- sf::st_transform(co110_sf, crs = "+proj=laea +x_0=0 +y_0=0 +lon_0=0 +lat_0=0")
co110_sf_lamb
```

---

# 6.7 Conversão do CRS

## Projeção de Mollweide
```{r fig.align='center'}
plot(co110_sf_lamb$geom, graticule = TRUE)
```

---

# 6.7 Conversão do CRS

## Projeção azimutal de Lambert
```{r}
co110_sf_lamb <- sf::st_transform(co110_sf, crs = "+proj=laea +x_0=0 +y_0=0 +lon_0=-50 +lat_0=0")
co110_sf_lamb
```

---

# 6.7 Conversão do CRS

## Projeção de Mollweide
```{r fig.align='center'}
plot(co110_sf_lamb$geom, graticule = TRUE)
```

---

class: inverse, center, middle

# Tabela de atributos

---

# 6.8 Tabela de atributos

## Acessar a tabela de atributos de um `sf`
```{r}
# acessar a tabela de atributos
rc_use_tab <- sf::st_drop_geometry(rc_use)
rc_use_tab
```

```{r}
# classe
class(rc_use_tab)
```

---

# 6.9 Operações de atributos

## Seleção de feições pela tabela de atributos
```{r message=FALSE}
# tidyverse
library(tidyverse)

# filtro da feicao
rc_use_floresta <- rc_use %>% 
  dplyr::filter(CLASSE_USO == "formação florestal")
```

--

```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot( rc_use_floresta$geom, col = "forestgreen", main = NA, axes = TRUE, graticule = TRUE)
```

---

# 6.9 Operações de atributos

## Acessar os dados da tabela para operações
```{r}
# rename
rec_bairros_rename <- rec_bairros %>% 
  dplyr::rename(bairros = EBAIRRNOME)
rec_bairros_rename
```

---

# 6.9 Operações de atributos

## Funções do dplyr para manejo de feições

`**1 filter()**`<br>
`**2 distinc()**`<br>
`**3 slice()**`<br>
`**4 n_sample()**`<br>

---

# 6.9 Operações de atributos

## Funções do dplyr para manejo de dados da tabela de atributos

`**1 select()**`<br>
`**2 pull()**`<br>
`**3 rename()**`<br>
`**4 mutate()**`<br>
`**5 arrange()**`<br>
`**6 summarise()**`<br>
`**7 join()**`<br>

---

# 6.8 Operações geométricas

## Simplification
```{r}
# simplification
rec_bairros_simp <- sf::st_simplify(rec_bairros, dTolerance = 500)
rec_bairros_simp
```

---

# 6.8 Operações geométricas

## Simplification
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros[1], main = NA)
```

---

# 6.8 Operações geométricas

## Simplification
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_simp[1], main = NA)
```

---

# 6.8 Operações geométricas

## Centroides
```{r}
rec_bairros_cent <- sf::st_centroid(rec_bairros)
rec_bairros_cent
```

---

# 6.8 Operações geométricas

## Centroides
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_cent[1], main = NA)
```

---

# 6.8 Operações geométricas

## Buffer
```{r}
rec_bairros_buf <- rec_bairros %>% 
  dplyr::filter(EBAIRRNO_1 == "Caxangá") %>% 
  sf::st_buffer(1000)
rec_bairros_buf
```

---

# 6.8 Operações geométricas

## Buffer
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_buf$geom, main = NA)
```

---

# 6.8 Operações geométricas

## Uniao (Dissolve)
```{r}
rec_bairros_union <- sf::st_union(rec_bairros)
rec_bairros_union
```

---

# 6.8 Operações geométricas

## Uniao (Dissolve)
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_union[1], main = NA)
```

---

# 6.9 Operações espaciais

## Intersecção
```{r, warning=FALSE}
rc_cover_caxanga <- rec_bairros %>% 
  dplyr::filter(EBAIRRNO_1 == "Caxangá") %>% 
  sf::st_intersection(rc_cover, .)
rc_cover_caxanga
```

---

# 6.9 Operações espaciais

## Intersecção
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rc_cover_caxanga[1], main = NA)
```

---

# 6.9 Operações espaciais

## Pontos aleatórios
```{r}
rec_bairros_rp <- sf::st_sample(rec_bairros_union, 100)
rec_bairros_rp
```

---

# 6.9 Operações espaciais

## Pontos aleatórios
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_rp, pch = 20, cex = 2, main = NA)
```

---

# 6.9 Operações espaciais

## Quadrículas
```{r}
rec_bairros_grid <- sf::st_make_grid(rec_bairros_union, cellsize = 1000) %>% 
  sf::st_as_sf()
rec_bairros_grid
```

---

# 6.9 Operações espaciais

## Quadrículas
```{r eval=FALSE}
# pacote
library(tmap)

# plot
tm_shape(rec_bairros) +
  tm_fill() +
tm_shape(rec_bairros_grid) +
  tm_borders()
```

---

# 6.9 Operações espaciais

## Quadrículas
```{r echo=FALSE,message=FALSE,warning=FALSE, fig.align='center', out.width='60%'}
# pacote
library(tmap)

# plot
tm_shape(rec_bairros) +
  tm_fill() +
tm_shape(rec_bairros_grid) +
  tm_borders()
```

---

# 6.9 Operações espaciais

## Contar pontos nas quadrículas
```{r}
# contagem por célula
rec_bairros_grid_count <- rec_bairros_grid %>% 
  dplyr::mutate(n = sf::st_intersects(rec_bairros_grid, rec_bairros_rp) %>% 
                  lengths())
rec_bairros_grid_count
```

---

# 6.9 Operações espaciais

## Contar pontos nas quadrículas
```{r eval=FALSE}
# map
tm_shape(rec_bairros_grid_count) +
  tm_polygons(col = "n") +
tm_shape(rec_bairros_rp) +
  tm_dots(size = .5, alpha = .75) +
  tm_legend(legend.position = c("left", "bottom"))

```

---

# 6.9 Operações espaciais

## Contar pontos nas quadrículas
```{r echo=FALSE, message=FALSE,warning=FALSE, fig.align='center', out.width='60%'}
# map
tm_shape(rec_bairros_grid_count) +
  tm_polygons(col = "n") +
tm_shape(rec_bairros_rp) +
  tm_dots(size = .5, alpha = .75) +
  tm_legend(legend.position = c("left", "bottom"))

```

---

class: inverse, middle, center

# Dúvidas?

---

class: clear, middle

## Maurício Vancine

<br>

Contatos:

`r icon::fa_envelope(colour = "#0000ee")` [mauricio.vancine@gmail.com]()
<br>
`r icon::fa_twitter(colour = "#0000ee")` [@mauriciovancine](https://twitter.com/mauriciovancine)
<br>
`r icon::fa_github(colour = "#0000ee")` [mauriciovancine](https://mauriciovancine.netlify.com/)
<br>
`r icon::fa_link(colour = "#0000ee")` [mauriciovancine.netlify.com](https://mauriciovancine.netlify.com/)

Slides criados via pacote [xaringan](https://github.com/yihui/xaringan) e tema [Metropolis](https://github.com/pat-s/xaringan-metropolis)