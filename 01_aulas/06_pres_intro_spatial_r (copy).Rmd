---
title: "Introdução à análise geoespacial com R <br><br><br>"
subtitle: "6 Estrutura e manejo de dados geoespaciais (vetor) <br><br><br>"
author: "Maurício H. Vancine <br> Milton C. Ribeiro"
date: "22/10/2020"
output:
  xaringan::moon_reader:
    css: [metropolis, metropolis-fonts]
    lib_dir: libs
    nature:
      highlightStyle: rainbow
      highlightLines: true
      countIncrementalSlides: false
---

```{r,setup, include=FALSE}
options(htmltools.dir.version = FALSE, encoding = "UTF-8")
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

---

# 6.3 Importar dados vetoriais

## Dados de uma planilha .csv
```{r}
# .csv para .shp
si_ve <- si %>% 
  dplyr::mutate(lon = longitude, lat = latitude) %>% 
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4236)
si_ve
```

---

# 6.3 Importar dados vetoriais

## Dados de uma planilha .csv
```{r, fig.align='center', out.width='50%'}
# plot
plot(si_ve[1], pch = 20, main = NA)
```

---

# 6.3 Importar dados vetoriais

## Dados de GPS (.gpx)
```{r,message=FALSE}
# diretorio
setwd("/home/mude/data/github/disciplina-geoprocessamento/03_dados/03_gps")

# importar
gps <- sf::read_sf("10Set_2019_casa.gpx", layer = "waypoints")
```

---

# 6.3 Importar dados vetoriais

## Dados de uma planilha .csv
```{r, fig.align='center', out.width='60%'}
# plot
plot(gps[1], pch = 20, main = NA)
```

---

class: inverse, middle, center

# Dúvidas?

---

background-image: url(img/geo_vector_sf_classes.png)
background-size: 450px
background-position: 50% 60%

# 6.4 Tipos de dados vetoriais

---

background-image: url(https://www.neonscience.org/sites/default/files/images/dc-spatial-vector/pnt_line_poly.png)
background-size: 500px
background-position: 50% 70%

# 6.4 Tipos de dados vetoriais

---

# 6.5 Estrutura de dados vetoriais

## Informações geográficas e da tabela de atributos
```{r}
# bairros de refice
rec_bairros
```

---

# 6.5 Estrutura de dados vetoriais

## Informações geográficas e da tabela de atributos

```{r}
# extention
sf::st_bbox(rec_bairros)
```

--

```{r}
# projection
sf::st_crs(rec_bairros)
```

---

# 6.6 Tabela de atributos

## Acessar a tabela de atributos de um `sf`
```{r}
# acessar a tabela de atributos
rec_bairros_tab <- sf::st_drop_geometry(rec_bairros)
rec_bairros_tab
```

```{r}
# classe
class(rec_bairros_tab)
```

---

# 6.7 Operações com tabela de atributos

## Seleção de feições pela tabela de atributos
```{r,message=FALSE}
# tidyverse
library(tidyverse)

# filtro da feicao
rec_bairros_caxanga <- rec_bairros %>% 
  dplyr::filter(EBAIRRNO_1 == "Caxangá")
```

--

```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_caxanga[1], main = NA)
```

---

# 6.7 Operações com tabela de atributos

## Acessar os dados da tabela para operações
```{r}
rec_bairros_rename <- rec_bairros %>% 
  dplyr::rename(bairros = EBAIRRNOME)
rec_bairros_rename
```

---

# 6.7 Operações com tabela de atributos

## Funções do dplyr para manejo de feições

`**1 filter()**`<br>
`**2 distinc()**`<br>
`**3 slice()**`<br>
`**4 n_sample()**`<br>

---

# 6.7 Operações com tabela de atributos

## Funções do dplyr para manejo de dados da tabela de atributos

`**1 select()**`<br>
`**2 pull()**`<br>
`**3 rename()**`<br>
`**4 mutate()**`<br>
`**5 arrange()**`<br>
`**6 summarise()**`<br>
`**7 join()**`<br>

---

# 6.8 Operações geométricas

## Simplification
```{r}
# simplification
rec_bairros_simp <- sf::st_simplify(rec_bairros, dTolerance = 500)
rec_bairros_simp
```

---

# 6.8 Operações geométricas

## Simplification
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros[1], main = NA)
```

---

# 6.8 Operações geométricas

## Simplification
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_simp[1], main = NA)
```

---

# 6.8 Operações geométricas

## Centroides
```{r}
rec_bairros_cent <- sf::st_centroid(rec_bairros)
rec_bairros_cent
```

---

# 6.8 Operações geométricas

## Centroides
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_cent[1], main = NA)
```

---

# 6.8 Operações geométricas

## Buffer
```{r}
rec_bairros_buf <- rec_bairros %>% 
  dplyr::filter(EBAIRRNO_1 == "Caxangá") %>% 
  sf::st_buffer(1000)
rec_bairros_buf
```

---

# 6.8 Operações geométricas

## Buffer
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_buf[1], main = NA)
```

---

# 6.8 Operações geométricas

## Uniao (Dissolve)
```{r}
rec_bairros_union <- sf::st_union(rec_bairros)
rec_bairros_union
```

---

# 6.8 Operações geométricas

## Uniao (Dissolve)
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_union[1], main = NA)
```

---

# 6.9 Operações espaciais

## Intersecção
```{r, warning=FALSE}
rc_cover_caxanga <- rec_bairros %>% 
  dplyr::filter(EBAIRRNO_1 == "Caxangá") %>% 
  sf::st_intersection(rc_cover, .)
rc_cover_caxanga
```

---

# 6.9 Operações espaciais

## Intersecção
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rc_cover_caxanga[1], main = NA)
```

---

# 6.9 Operações espaciais

## Pontos aleatórios
```{r}
rec_bairros_rp <- sf::st_sample(rec_bairros_union, 100)
rec_bairros_rp
```

---

# 6.9 Operações espaciais

## Pontos aleatórios
```{r echo=FALSE, fig.align='center', out.width='50%'}
# plot
plot(rec_bairros_rp, pch = 20, cex = 2, main = NA)
```

---

# 6.9 Operações espaciais

## Quadrículas
```{r}
rec_bairros_grid <- sf::st_make_grid(rec_bairros_union, cellsize = 1000) %>% 
  sf::st_as_sf()
rec_bairros_grid
```

---

# 6.9 Operações espaciais

## Quadrículas
```{r eval=FALSE}
# pacote
library(tmap)

# plot
tm_shape(rec_bairros) +
  tm_fill() +
tm_shape(rec_bairros_grid) +
  tm_borders()
```

---

# 6.9 Operações espaciais

## Quadrículas
```{r echo=FALSE,message=FALSE,warning=FALSE, fig.align='center', out.width='60%'}
# pacote
library(tmap)

# plot
tm_shape(rec_bairros) +
  tm_fill() +
tm_shape(rec_bairros_grid) +
  tm_borders()
```

---

# 6.9 Operações espaciais

## Contar pontos nas quadrículas
```{r}
# contagem por célula
rec_bairros_grid_count <- rec_bairros_grid %>% 
  dplyr::mutate(n = sf::st_intersects(rec_bairros_grid, rec_bairros_rp) %>% 
                  lengths())
rec_bairros_grid_count
```

---

# 6.9 Operações espaciais

## Contar pontos nas quadrículas
```{r eval=FALSE}
# map
tm_shape(rec_bairros_grid_count) +
  tm_polygons(col = "n") +
tm_shape(rec_bairros_rp) +
  tm_dots(size = .5, alpha = .75) +
  tm_legend(legend.position = c("left", "bottom"))

```

---

# 6.9 Operações espaciais

## Contar pontos nas quadrículas
```{r echo=FALSE, message=FALSE,warning=FALSE, fig.align='center', out.width='60%'}
# map
tm_shape(rec_bairros_grid_count) +
  tm_polygons(col = "n") +
tm_shape(rec_bairros_rp) +
  tm_dots(size = .5, alpha = .75) +
  tm_legend(legend.position = c("left", "bottom"))

```

---

# 6.10 Reprojeção e exportar um vetor

## Reprojetar um vetor
```{r include=FALSE}
# directory
setwd("/home/mude/data/github/disciplina-geoprocessamento/03_dados/01_vetor/recife_prefeitura")

# import
rec_bairros <- sf::st_read("Bairros.shp", quiet = TRUE)

# plot
plot(rec_bairros[1], main = NA)
```

```{r}
# reprojection
sf::st_crs(rec_bairros)
```

--

```{r}
# reprojection
rec_bairros_geo <- sf::st_transform(rec_bairros, 4326)
```

--

```{r}
# reprojection
sf::st_crs(rec_bairros_geo)
```

---

# 6.10 Reprojeção e exportar um vetor

## Exportar um vetor
```{r eval=FALSE}
# directory
setwd("/home/mude/data/github/disciplina-geoprocessamento/03_dados/01_vetor/recife_prefeitura")

# export
sf::st_write(rec_bairros_geo, "bairros_gcs_wgs84.shp")
```
