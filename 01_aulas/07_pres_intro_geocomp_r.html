<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Introdução à análise geoespacial com R    </title>
    <meta charset="utf-8" />
    <meta name="author" content="Maurício H. Vancine   Milton C. Ribeiro" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/metropolis.css" rel="stylesheet" />
    <link href="libs/remark-css/metropolis-fonts.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/fontawesome-all.min.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Introdução à análise geoespacial com R <br><br><br>
## 7 Estrutura e manejo de dados matriciais <br><br><br>
### Maurício H. Vancine <br> Milton C. Ribeiro
### 23/10/2020

---




class: clear
background-image: url(img/geo_raster_wd.png)
background-size: 800px

---

background-image: url(img/r_spatial.jpeg)
background-size: 350px
background-position: 80% 65%

# 7 Estrutura e manejo de dados raster

## Tópicos
1. Pacotes
1. Dados raster
1. Classes raster
1. Importar dados matriciais
1. Descrição de objetos raster
1. Converter CRS
1. Manipulação de dados raster
1. Operação espaciais
1. Operações geométricas
1. Interações raster-vetor
1. Conversões raster-vetor
1. Exportar dados matriciais

---

# 7 Estrutura e manejo de dados raster

## Script

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;

## .center[`07_script_intro_geocomp_r.R`]

---

background-image: url(img/geo_raster_package.png)
background-size: 650px
background-position: 50% 70%

# 7.1 Pacotes

## Pacote raster

```r
# raster
install.packages("raster")
library(raster)
```

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;

[*] https://rspatial.org/raster/pkg/

---

background-image: url(img/geo_terra_package.png)
background-size: 650px
background-position: 50% 70%

# 7.1 Pacotes

## Pacote terra

```r
# raster
install.packages("terra")
library(terra)
```

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;

[*] https://rspatial.org/terra/pkg/

---

background-image: url(img/geo_raster_stars.png)
background-size: 500px
background-position: 50% 70%

# 7.1 Pacotes

## Pacote stars

```r
# raster
install.packages("stars")
library(stars)
```

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;

[*] https://r-spatial.github.io/stars/

---

background-image: url(img/geo_raster.png)
background-size: 500px
background-position: 50% 90%

# 7.2 Dados raster

## Raster ou Gride ou Dado Matricial (matriz)

---

background-image: url(img/geo_raster_cont_cat.png)
background-size: 700px
background-position: 50% 70%

# 7.2 Dados raster

## Tipos de dados: contínuos ou categóricos

---

background-image: url(img/geo_raster_plot.png)
background-size: 800px
background-position: 50% 70%

# 7.2 Dados raster

## Valores

---

background-image: url(img/geo_raster_single_multi_raster.png)
background-size: 800px
background-position: 50% 70%

# 7.3 Classes raster

## RasterLayer, RasterStack ou RasterBrick

---

background-image: url(img/geo_raster_single_raster.png)
background-size: 350px
background-position: 50% 80%

# 7.3 Classes raster

## RasterLayer

### A classe **RasterLayer** representa apenas uma camada raster, representando **uma variável**

---

# 7.3 Classes raster

## RasterLayer

### A classe **RasterLayer** representa apenas uma camada raster, representando **uma variável**

```r
# volcano
volcano
```

---

# 7.3 Classes raster

## RasterLayer

### A classe **RasterLayer** representa apenas uma camada raster, representando **uma variável**

```r
# rasterlayer
ra_lay &lt;- raster::raster(volcano)
ra_lay
```

---

# 7.3 Classes raster

## RasterLayer

### A classe **RasterLayer** representa apenas uma camada raster, representando **uma variável**

```r
# plot
raster::plot(ra_lay)
```

---

# 7.3 Classes raster

## RasterLayer

### A classe **RasterLayer** representa apenas uma camada raster, representando **uma variável**

```r
# plot
raster::plot(ra_lay, col = viridis::viridis(10))
```

---

# 7.3 Classes raster

## RasterLayer

### A classe **RasterLayer** representa apenas uma camada raster, representando **uma variável**

```r
# plot
raster::plot(ra_lay, col = viridis::viridis(100))
```

---

background-image: url(img/geo_raster_multi_raster.png)
background-size: 350px
background-position: 50% 90%

# 7.3 Classes raster

## RasterStack

### A classe **RasterStack** é uma lista de objetos **RasterLayer** com a mesma extensão e resolução, representando **várias variáveis**

---

# 7.3 Classes raster

## RasterStack

```r
# stack
set.seed(42)
ra_sta &lt;- raster::stack(raster::raster(volcano), 
                        raster::raster(matrix(rnorm(5307), nrow = 87)),
                        raster::raster(matrix(rbinom(5307, 1, .5), nrow = 87)))
ra_sta
```

---

# 7.3 Classes raster

## RasterStack

```r
# plot
raster::plot(ra_sta, col = viridis::viridis(10))
```

---

background-image: url(img/geo_raster_multi_raster.png)
background-size: 350px
background-position: 50% 90%

# 7.3 Classes raster

## RasterBrick

### A classe **RasterBrick** também é uma lista de objetos **RasterLayer** com a mesma extensão e resolução

---

background-image: url(img/geo_raster_brick.jpg)
background-size: 600px
background-position: 50% 90%

# 7.3 Classes raster

## RasterBrick

### A principal diferença entre **RasterBrick** e **RasterStack** é que um **RasterBrick** é vinculado a um **único arquivo (multicamadas)**

---

# 7.3 Classes raster

## RasterBrick

```r
# brick
set.seed(42)
ra_bri &lt;- raster::brick(raster::raster(volcano), 
                        raster::raster(matrix(rnorm(5307), nrow = 87)),
                        raster::raster(matrix(rbinom(5307, 1, .5), nrow = 87)))
ra_bri
```

---

# 7.3 Classes raster

## RasterBrick

```r
# plot
raster::plot(ra_bri, col = viridis::viridis(10))
```

---

class: inverse, middle, center

# Importar dados raster

---

class: inverse, middle, center

# Dados de elevação

---

background-image: url(img/geo_raster_dem01.png), url(img/geo_raster_dem02.png)
background-size: 340px,350px
background-position: 10% 90%,85% 90%

# 7.4 Importar dados matriciais

## Dados de elevação

### Modelo Digital de Elevação (DEM) ou Superfície (DSM)

---

background-image: url(img/geo_raster_srtm01.png), url(img/geo_raster_srtm02.png), url(img/geo_raster_srtm03.png)
background-size: 400px,200px,320px
background-position: 10% 90%,65% 45%, 95% 85%

# 7.4 Importar dados matriciais

## Dados de elevação

### SRTM

&gt; - Farr, Tom G. et al. ["The Shuttle Radar Topography Mission."](https://doi.org/10.1002/joc.5086) Reviews of Geophysics 45.2 (2007): 1.

---

# 7.4 Importar dados matriciais

## Dados de elevação (SRTM)

### Download

### Criar um diretório

```r
# create directory
dir.create(here::here("03_dados", "raster"))
```

--

### Download de dados de elevação

```r
# increase time to download
options(timeout = 600)

# download
raster::getData(name = "SRTM", lon = -47, lat = -23, 
                path = here::here("03_dados", "raster"))
```

[*] http://srtm.csi.cgiar.org/download

---

# 7.4 Importar dados matriciais

## Importar uma camada

### RasterLayer

```r
# import raster
ra &lt;- raster::raster(here::here("03_dados", "raster", "srtm_27_17.tif"))
ra
```

---

# 7.4 Importar dados matriciais

## Importar uma camada

### Rio Claro

```r
# rio claro
rc_2019 &lt;- geobr::read_municipality(code_muni = 3543907, year = 2019, showProgress = FALSE) %&gt;% 
  sf::st_transform(crs = 4326)
rc_2019
```

---

# 7.4 Importar dados matriciais

## Importar uma camada

### RasterLayer

```r
# plot
raster::plot(ra, col = viridis::viridis(10))
plot(rc_2019$geom, col = "red", add = TRUE)
```

---

background-image: url(img/geo_raster_crop_mask_buffer_square.png)
background-size: 700px
background-position: 50% 80%

# 7.4 Importar dados matriciais

## Importar uma camada

### Crop do RasterLayer

---

# 7.4 Importar dados matriciais

## Importar uma camada

### Crop do RasterLayer

```r
# mask
ra_rc &lt;- raster::crop(ra_rc, rc_2019)
ra_rc
```

---

# 7.4 Importar dados matriciais

## Importar uma camada

### Crop do RasterLayer

```r
# plot
raster::plot(ra_rc, col = viridis::viridis(10))
plot(rc_2019$geom, lwd = 2, add = TRUE)
```

---

class: inverse, middle, center

# Dados bioclimáticos

---

background-image: url(img/geo_raster_wc_artigo.png)
background-size: 600px
background-position: 50% 90%

# 7.4 Importar dados matriciais

## O que é o WorldClim?
- Principal bases de **dados climáticos** para o mundo
- Dados temporais de **temperatura e precipitação**
- Construído à partir de dados de **estações meteorológicas, interpolação e topografia**
- Principal forma de uso: **variáveis bioclimáticas**

&gt; - Fick, Stephen E., Hijmans, Robert J. ["WorldClim 2: new 1‐km spatial resolution climate surfaces for global land areas."](https://doi.org/10.1002/joc.5086) International Journal of Climatology 37.12 (2017): 4302.

---

background-image: url(img/geo_raster_wc_mapas.png)
background-size: 400px
background-position: 50% 75%

# 7.4 Importar dados matriciais

## Estações meteorológicas

---

background-image: url(img/geo_raster_wc_method.png)
background-size: 600px
background-position: 50% 60%

# 7.4 Importar dados matriciais

## Interpolação

---

background-image: url(img/geo_raster_wc_interpolation.png)
background-size: 450px
background-position: 50% 65%

# 7.4 Importar dados matriciais

## Interpolação

---

background-image: url(img/geo_raster_bioclim.png)
background-size: 550px
background-position: 50% 90%

# 7.4 Importar dados matriciais

## Variáveis Bioclimáticas

- São **19 variáveis** relacionadas com a **biologia das organismos**

- Combinações temporais de **temperatura (BIO01-BIO11)** e **precipitação (BIO12-BIO19)**

---

background-image: url(img/geo_raster_bio01.png)
background-size: 800px
background-position: 50% 70%

# 7.4 Importar dados matriciais

## Variáveis Bioclimáticas

### BIO01: Temperatura média anual (º C)

---

background-image: url(img/geo_raster_merraclim.jpg)
background-size: 800px
background-position: 50% 75%

# 7.4 Importar dados matriciais

## Variáveis Bioclimáticas

### Disponível em **várias resoluções** e **períodos (passado, presente e futuro)**

---

background-image: url(img/geo_raster_worldclim.png)
background-size: 800px
background-position: 50% 55%

# 7.4 Importar dados matriciais

## Site

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;

[*] https://www.worldclim.org/

---

# 7.4 Importar dados matriciais

## Download
### Download de dados bioclimáticos

```r
# download
download.file(url = "https://biogeo.ucdavis.edu/data/worldclim/v2.1/base/wc2.1_10m_bio.zip",
              destfile = here::here("03_dados", "raster", "wc2.0_10m_bio.zip"), mode = "wb")
```

--

### Unzip

```r
# unzip
unzip(zipfile = here::here("03_dados", "raster", "wc2.0_10m_bio.zip"))
```

---

# 7.4 Importar dados matriciais

## Importar várias camadas

### Listar arquivos

```r
# list files
fi &lt;- dir(path = here::here("03_dados", "raster"), pattern = "wc") %&gt;% 
  grep(".tif", ., value = TRUE)
fi
```

---

# 7.4 Importar dados matriciais

## Importar várias camadas

### RasterStack

```r
# import stack
st &lt;- raster::stack(here::here("03_dados", "raster", fi))
st
```

---

# 7.4 Importar dados matriciais

## Importar várias camadas

### RasterStack

```r
# map
raster::plot(st[[1:2]], col = viridis::viridis(10))
```

---

class: inverse, center, middle
# Objeto raster

---

# 7.5 Descrição de objetos raster

## Informações

```r
ra
```

- *class*: classe raster do objeto
- *dimensions*: número de linhas, colunas, células e camadas
- *resolution*: largura e altura da célula
- *extent*: coordenadas mínimas e máximas da longitude e latitude
- *crs*: Sistema de Referência de Coordenadas
- *source*: fonte dos dados (memória ou disco)
- *names*: nome das camadas
- *values*: valores máximos e mínimos das células

---

# 7.5 Descrição de objetos raster

## Informações

#### Classe

```r
class(ra)
```
--
#### Dimensões

```r
dim(ra)
```
--
#### Número de camadas

```r
nlayers(ra)
```

---

background-image: url(img/geo_raster.png)
background-size: 450px
background-position: 50% 90%

# 7.5 Descrição de objetos raster

## Informações

### Número de linhas, colunas e células

---

# 7.5 Descrição de objetos raster

## Informações

#### Número de linhas

```r
nrow(ra)
```
--
#### Número de colunas

```r
ncol(ra)
```
--
#### Número de células

```r
ncell(ra)
```

---

background-image: url(img/geo_raster_resolution.png)
background-size: 650px
background-position: 50% 80%

# 7.5 Descrição de objetos raster

## Informações

### Resolução

---

# 7.5 Descrição de objetos raster

## Informações

### Resolução

```r
# raster resolution
res(ra)
```
--

```r
# stack resolution
res(st)
```

---

background-image: url(img/geo_raster_extent.png)
background-size: 600px
background-position: 50% 90%

# 7.5 Descrição de objetos raster

## Informações

### Extenção

---

# 7.5 Descrição de objetos raster

## Informações

### Extenção

```r
# raster extent
extent(ra)
```
--

```r
# stack extent
extent(st)
```

---

# 7.5 Descrição de objetos raster

## Informações

### Projeção

```r
# projection
projection(ra)
```
--

```r
# projection
projection(st)
```

---

# 7.5 Descrição de objetos raster

## Informações

### Nomes

```r
# raster names
names(ra)
```
--

```r
# stack names
names(st)
```

---

background-image: url(img/geo_raster_values.gif)
background-size: 650px
background-position: 50% 90%

# 7.5 Descrição de objetos raster

## Informações

### Valores

---

# 7.5 Descrição de objetos raster

## Informações

### Valores

```r
getValues(ra)
```

---

# 7.5 Descrição de objetos raster

## Informações

### Valores

```r
values(ra)
```

---

# 7.5 Descrição de objetos raster

## Informações

### Valores

```r
ra[]
```

---

# 7.5 Descrição de objetos raster

## Informações

### Valores

```r
ra %&gt;% 
  raster::values() %&gt;% 
  hist(col = "steelblue", border = "white", main = NA, xlab = "Elevação (m)", ylab = "Frequência")
```

---

# 7.5 Descrição de objetos raster

## Informações

### Valores

```r
raster::values(st[[1:3]])
```

---

# 7.5 Descrição de objetos raster

## Informações

### Valores

```r
st[[1:3]] %&gt;% 
  raster::values() %&gt;% 
  tibble::as_tibble() %&gt;% 
  dplyr::sample_n(1e3) %&gt;% 
  pairs(cex = 1.3, pch = 20, col = adjustcolor("gray50", .7))
```

---

class: inverse, center, middle

# Conversão do CRS

---

background-image: url(img/geo_raster_reprojection.png)
background-size: 550px
background-position: 50% 70%

# 7.6 Conversão do CRS

## Reprojeção

---

background-image: url(img/geo_raster_crs.png)
background-size: 800px
background-position: 50% 90%

# 7.6 Conversão do CRS

## Reprojeção
1. Reprojeção vetorial de centróides celulares (muda a **posição e tamanho** do pixel)
1. Cálculo de novos valores dos pixels por meio de reamostragem (muda o **valor** do pixel)

---

# 7.6 Conversão do CRS

## Converter CRS local

### WGS84/GCS -&gt; SIRGAS2000/UTM23S (proj4string)

```r
ra_rc
```

---

# 7.6 Conversão do CRS

## Converter CRS local

### WGS84/GCS -&gt; SIRGAS2000/UTM23S (proj4string)

```r
# proj4string utm 23 s
utm23 &lt;- "+proj=utm +zone=23 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
utm23
```
--

```r
# reprojection
ra_rc_utm23 &lt;- raster::projectRaster(ra_rc, crs = utm23, res = 90, method = "bilinear")
ra_rc_utm23
```

[*] https://epsg.io/31983

[*] https://pro.arcgis.com/en/pro-app/help/mapping/properties/transverse-mercator.htm

---

# 7.6 Conversão do CRS

## Converter CRS local

### WGS84/GCS -&gt; SIRGAS2000/UTM23S (proj4string)

```r
# plot
plot(ra_rc_utm23, col = viridis::viridis(10))
```

---

# 7.6 Conversão do CRS

## Converter CRS global

### Datum WGS84 e coordenadas geográficas

```r
# WGS84/GCS
st$wc2.1_10m_bio_1
```

---

# 7.6 Conversão do CRS

## Converter CRS global

### Datum WGS84 e coordenadas geográficas

```r
# plot
plot(st$wc2.1_10m_bio_1, col = viridis::viridis(10))
```

---

# 7.6 Conversão do CRS

## Converter CRS global

### Projeção de Mollweide: preserva as relações de área

```r
# proj4string mollweide
moll &lt;- "+proj=moll +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"
moll
```
--

```r
# reprojection
bio01_moll &lt;- raster::projectRaster(st$wc2.1_10m_bio_1, crs = moll, res = 25e3, method = "bilinear")
bio01_moll
```

[*] https://epsg.io/54009

[*] https://pro.arcgis.com/en/pro-app/help/mapping/properties/mollweide.htm

---

# 7.6 Conversão do CRS

## Converter CRS global

### Projeção de Mollweide

```r
# plot
plot(bio01_moll, col = viridis::viridis(10))
```

---

# 7.6 Conversão do CRS

## Converter CRS global

### Projeção de Winkel Tripel: mínimo de distorção para área, direção e distância

```r
# proj4string winkel tripel
wintri &lt;- "+proj=wintri +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"
wintri
```
--

```r
# reprojection
bio01_wintri &lt;- raster::projectRaster(st$wc2.1_10m_bio_1, crs = wintri, res = 25e3, method = "bilinear")
bio01_wintri
```

[*] https://pro.arcgis.com/en/pro-app/help/mapping/properties/winkel-tripel.htm

---

# 7.6 Conversão do CRS

## Converter CRS global

### Projeção de Winkel Tripel

```r
# plot
plot(bio01_wintri, col = viridis::viridis(10))
```

---

# 7.6 Conversão do CRS

## Converter CRS global

### Projeção de Eckert IV: presenva a área e com meridianos elípticos

```r
# proj4string eckert iv
eck4 &lt;- "+proj=eck4 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"
eck4
```
--

```r
# reprojection
bio01_eck4 &lt;- raster::projectRaster(st$wc2.1_10m_bio_1, crs = eck4, res = 25e3, method = "bilinear")
bio01_eck4
```

[*] https://epsg.io/54012

[*] https://pro.arcgis.com/en/pro-app/help/mapping/properties/eckert-iv.htm

---

# 7.6 Conversão do CRS

## Converter CRS global

### Projeção de Eckert IV

```r
# plot
plot(bio01_eck4, col = viridis::viridis(10))
```

---

# 7.6 Conversão do CRS

## Converter CRS global

### Projeção azimutal de Lambert: preserva os tamanhos relativos e senso de direção a partir do centro

```r
# proj4string lambert 
laea &lt;- "+proj=laea +x_0=0 +y_0=0 +lon_0=0 +lat_0=0"
laea
```
--

```r
# reprojection
bio01_laea &lt;- raster::projectRaster(st$wc2.1_10m_bio_1, crs = laea, res = 25e3, method = "bilinear")
bio01_laea
```

[*] https://pro.arcgis.com/en/pro-app/help/mapping/properties/lambert-azimuthal-equal-area.htm

---

# 7.6 Conversão do CRS

## Converter CRS global

### Projeção azimutal de Lambert

```r
# plot
plot(bio01_laea, col = viridis::viridis(10))
```

---

class: inverse, center, middle
# Manipulação de raster

---

# 7.7 Manipulação de dados raster

## Subset do raster

### Indexação de linha-coluna ou id da célula

```r
# raster - row 1, column 1
ra[1, 1]
```
--

```r
# cell is 1
ra[1]
```

---

# 7.7 Manipulação de dados raster

## Subset do raster

### Indexação de linha-coluna ou id da célula

```r
# stack - row 1, column 1
st[1, 1]
```
--

```r
# cell is 1
st[1]
```

---

# 7.7 Manipulação de dados raster

## Subset do raster

### Seleção de RasterLayer no StackLayer

```r
# selection layer in stack
st_bio01 &lt;- raster::subset(st, "wc2.1_10m_bio_1")
st_bio01
```

---

# 7.7 Manipulação de dados raster

## Subset do raster

### Seleção de RasterLayer no StackLayer

```r
# selection layer in stack
st_bio01 &lt;- raster::raster(st, layer = 1)
st_bio01
```

---

# 7.7 Manipulação de dados raster

## Subset do raster

### Seleção de RasterLayer no StackLayer [[]]

```r
# selection layer in stack
st_bio01 &lt;- st[["wc2.1_10m_bio_1"]]
st_bio01
```

---

# 7.7 Manipulação de dados raster

## Subset do raster

### Seleção de RasterLayer no StackLayer [[]]

```r
# selection layer in stack
st_bio01 &lt;- st[[1]]
st_bio01
```

---

# 7.7 Manipulação de dados raster

## Subset do raster

### Seleção de RasterLayer no StackLayer $

```r
# selection layer in stack
st_bio01 &lt;- st$wc2.1_10m_bio_1
st_bio01
```

---

# 7.7 Manipulação de dados raster

## Subset do raster

### Seleção de RasterLayer no StackLayer $

```r
# map
raster::plot(st_bio01, col = viridis::viridis(10))
```

---

# 7.7 Manipulação de dados raster

## Renomear rasters

```r
# names
names(ra_rc)
```
--

```r
# rename
names(ra_rc) &lt;- "elevation"
```
--

```r
# names
names(ra_rc)
```

---

# 7.7 Manipulação de dados raster

## Renomear rasters

```r
# name
names(st)
```
--

```r
# rename
names(st) &lt;- c("bio01", paste0("bio", 10:19), paste0("bio", 2:9))
```
--

```r
# names
names(ra_rc)
```

---

# 7.7 Manipulação de dados raster

## Resumir informações do raster

### Média de todos os valores

```r
# mean from all cells
raster::cellStats(ra_rc, mean)
```

---

# 7.7 Manipulação de dados raster

## Resumir informações do raster

### Média de todos os valores

```r
# mean from all cells
raster::cellStats(st[[1:3]], mean)
```

---

# 7.7 Manipulação de dados raster

## Resumir informações do raster

### Frequência de cada valor

```r
# count cells
raster::freq(ra_rc)
```

---

# 7.7 Manipulação de dados raster

## Resumir informações do raster

### Frequência de cada valor

```r
# count cells
raster::freq(st[[1:3]])
```

---

class: inverse, center, middle
# Operação espaciais

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster 

```r
# sum
ra_rc2 &lt;- ra_rc + ra_rc
ra_rc2
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster 

```r
# map
raster::plot(ra_rc2)
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster 

```r
# division
ra_rc_km &lt;- ra_rc / 1e3
ra_rc_km
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster 

```r
# map
raster::plot(ra_rc_km)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster 

```r
# log10
ra_rc_log10 &lt;- log10(ra_rc)
ra_rc_log10
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster 

```r
# map
raster::plot(ra_rc_log10)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster por valor

```r
# upper 600
ra_rc_up_600 &lt;- ra_rc &gt; 600
ra_rc_up_600
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster por valor

```r
# map
raster::plot(ra_rc_up_600)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster por valor

```r
# bottom
ra_rc_bot_600 &lt;- ra_rc &lt;= 600
ra_rc_bot_600
```

---

# 7.8 Operações espaciais

## Operações locais 

### Álgebra de raster por valor

```r
# map
raster::plot(ra_rc_bot_600)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.8 Operações espaciais

## Operações locais 

### Alterar valores

```r
# values
ra_rc[]
```

---

# 7.8 Operações espaciais

## Operações locais 

### Alterar valores

```r
# copy
ra_rc_up_700 &lt;- ra_rc
ra_rc_up_700
```
--

```r
# values bottom 700 == NA
ra_rc_up_700[ra_rc_up_700 &lt; 700] &lt;- NA
ra_rc_up_700
```

---

# 7.8 Operações espaciais

## Operações locais 

### Alterar valores

```r
# map
raster::plot(ra_rc_up_700)
plot(rc_2019$geom, add = TRUE)
```

---

background-image: url(img/geo_raster_reclass.gif)
background-size: 700px
background-position: 50% 70%

# 7.8 Operações espaciais

## Operações locais 

### Reclassify

---

# 7.8 Operações espaciais

## Operações locais 

### Reclassify

```r
rcl  &lt;- matrix(c(400,500,4, 
                 500,600,5, 
                 600,700,6,
                 700,800,7,
                 800,900,8,
                 900,1000,9), 
               ncol = 3, byrow = TRUE)
rcl
```

---

# 7.8 Operações espaciais

## Operações locais 

### Reclassify

```r
ra_rc_rcl &lt;- raster::reclassify(ra_rc, rcl = rcl)
ra_rc_rcl
```

---

# 7.8 Operações espaciais

## Operações locais 

### Reclassify

```r
# plot
raster::plot(ra_rc_rcl)
plot(rc_2019$geom, add = TRUE)
```

---

background-image: url(img/geo_raster_focal.png)
background-size: 600px
background-position: 50% 70%

# 7.8 Operações espaciais

## Operação focal

### Moving window

---

background-image: url(img/geo_raster_moving_window.gif),url(img/geo_raster_focal.png)
background-size: 400px,600px
background-position: 20% 65%,50% 70%

# 7.8 Operações espaciais

## Operação focal

### Moving window

---

# 7.8 Operações espaciais

## Operação focal

### Moving window

```r
# map
ra_rc_mw_sd &lt;- raster::focal(ra_rc, w = matrix(1, nrow = 3, ncol = 3), fun = sd)
ra_rc_mw_sd
```

---

# 7.8 Operações espaciais

## Operação focal

### Moving window

```r
# map
raster::plot(ra_rc_mw_sd)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.8 Operações espaciais

## Operação zonal

```r
raster::zonal(ra_rc, ra_rc_rcl, fun = "mean")
```

---

# 7.8 Operações espaciais

## Operação zonal

```r
ra_rc_stats &lt;- data.frame(raster::zonal(ra_rc, ra_rc_rcl, fun = "summary"))
colnames(ra_rc_stats) &lt;- c("zone", "min", "1qt", "median", "mean", "3qt", "max")
ra_rc_stats
```

---

class: inverse, center, middle
# Operações geométricas

---

background-image: url(img/geo_raster_aggregate.png)
background-size: 700px
background-position: 50% 70%

# 7.9 Operações geométricas

## Agregação e desagregação

---

background-image: url(img/geo_raster_long_lat_dist.gif)
background-size: 650px
background-position: 50% 90%

# 7.9 Operações geométricas

## Resolução - Relação de graus e distância em metros

---

# 7.9 Operações geométricas

## Agregação

```r
# resolution
res(ra_rc)[1]
```
--

```r
# aggregation - increases the pixel size of the raster
ra_rc_agg_mean &lt;- raster::aggregate(ra_rc, fact = 10, fun = "mean")
ra_rc_agg_mean
```
--

```r
# new resolution
res(ra_rc_agg_mean)[1]
```

---

# 7.9 Operações geométricas

## Agregação

```r
# map
raster::plot(ra_rc_agg_mean)
plot(rc_2019$geom, add = TRUE)
```

---

background-image: url(img/geo_raster_disaggregate.png)
background-size: 700px
background-position: 50% 70%

# 7.9 Operações geométricas

## Desagregação

---

# 7.9 Operações geométricas

## Desagregação

```r
# resolution
res(ra_rc)[1]
```
--

```r
# disaggregate - decreases the pixel size of the raster
ra_rc_dis_bil &lt;- raster::disaggregate(ra_rc, fact = 2, fun = "bilinear")
ra_rc_dis_bil
```
--

```r
# new resolution
res(ra_rc_dis_bil)[1]
```

---

# 7.9 Operações geométricas

## Agregação

```r
# map
raster::plot(ra_rc_dis_bil)
plot(rc_2019$geom, add = TRUE)
```

---

class: inverse, center, middle
# Interações raster-vetor

---

background-image: url(img/geo_raster_crop_mask.png)
background-size: 800px
background-position: 50% 60%

# 7.10 Interações raster-vetor

## Raster cropping

---

# 7.10 Interações raster-vetor

## Raster cropping

### Crop

```r
# crop - adjust extension
ra_rc_crop &lt;- raster::crop(ra, rc_2019)
ra_rc_crop
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Crop

```r
plot(ra_rc_crop)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Mask

```r
# mask - adjust limit
ra_rc_mask &lt;- raster::mask(ra, rc_2019)
ra_rc_mask
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Mask

```r
plot(ra_rc_mask)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Crop and Mask

```r
# crop and mask - adjust extension and limit
ra_rc_crop_mask &lt;- ra %&gt;% 
  raster::crop(rc_2019) %&gt;% 
  raster::mask(rc_2019)
ra_rc_crop_mask
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Mask

```r
plot(ra_rc_crop_mask)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Crop and Mask

```r
# crop and mask inverse - adjust extension and limit
ra_rc_crop_mask_inv &lt;- ra %&gt;% 
  raster::crop(rc_2019) %&gt;% 
  raster::mask(rc_2019, inverse = TRUE)
ra_rc_crop_mask_inv
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Crop and Mask inverse

```r
plot(ra_rc_crop_mask_inv)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Crop and Mask

```r
# download atlantic forest
af &lt;- geobr::read_biomes(year = 2004) %&gt;% 
  dplyr::filter(name_biome == "Mata Atlântica")
af
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Crop and Mask

```r
# plot
plot(af$geom, main = NA, axes = TRUE, gratidule = TRUE)
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Crop and Mask

```r
# crop and mask - adjust extension and limit
st_af_crop_mask &lt;- st %&gt;% 
  raster::crop(af) %&gt;% 
  raster::mask(af)
st_af_crop_mask
```

---

# 7.10 Interações raster-vetor

## Raster cropping

### Mask

```r
plot(st_af_crop_mask[[1:12]])
```

---

# 7.10 Interações raster-vetor

## Raster extraction

### Importar pontos

```r
# import points
rc_spr &lt;- sf::st_read(here::here("03_dados", "vetor", "SP_3543907_NASCENTES.shp"), quiet = TRUE) %&gt;% 
  sf::st_transform(crs = 4326)
rc_spr
```

---

# 7.10 Interações raster-vetor

## Raster extraction

### Importar pontos

```r
# import points
# plot
plot(rc_spr$geometry, pch = 20, col = "blue", main = NA, axes = TRUE, graticule = TRUE)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.10 Interações raster-vetor

## Raster extraction

```r
# extraction
rc_spr_ele &lt;- raster::extract(ra_rc, rc_spr)
rc_spr_ele
```

---

# 7.10 Interações raster-vetor

## Raster extraction

```r
# extraction
rc_spr_ele &lt;- rc_spr %&gt;% 
  dplyr::mutate(elev = raster::extract(ra_rc, .))
rc_spr_ele
```

---

# 7.10 Interações raster-vetor

## Raster extraction

### Importar pontos

```r
# import points
# plot
plot(rc_spr_ele["elev"], pch = 20, main = NA, axes = TRUE, graticule = TRUE)
```

---

# 7.10 Interações raster-vetor

## Zonal Statistics

### Buffers

```r
# buffers
set.seed(42)
rc_spr_buf &lt;- rc_spr %&gt;% 
  dplyr::sample_n(10) %&gt;% 
  sf::as_Spatial() %&gt;% 
  raster::buffer(width = 1000, dissolve = FALSE) %&gt;% 
  sf::st_as_sf()
rc_spr_buf
```

---

# 7.10 Interações raster-vetor

## Zonal Statistics

### Buffers

```r
# plot
plot(rc_spr_buf$geometry, pch = 20, main = NA, axes = TRUE, graticule = TRUE)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.10 Interações raster-vetor

## Zonal Statistics

### Buffers

```r
raster::extract(x = ra_rc, y = rc_spr_buf, fun = mean, na.rm = TRUE, df = TRUE)
```

---

# 7.10 Interações raster-vetor

## Zonal Statistics

### Buffers

```r
rc_spr_buf &lt;- rc_spr_buf %&gt;% 
  dplyr::mutate(elev_mean = raster::extract(x = ra_rc, y = rc_spr_buf, fun = mean, na.rm = TRUE),
                elev_sd = raster::extract(x = ra_rc, y = rc_spr_buf, fun = sd, na.rm = TRUE))
rc_spr_buf
```

---

# 7.10 Interações raster-vetor

## Raster extraction

### Buffers

```r
# plot
plot(rc_spr_buf["elev_mean"], pch = 20, main = NA, axes = TRUE, graticule = TRUE)
```

---

# 7.10 Interações raster-vetor

## Raster extraction

### Buffers

```r
# plot
plot(rc_spr_buf["elev_sd"], pch = 20, main = NA, axes = TRUE, graticule = TRUE)
```

---

class: inverse, center, middle
# Conversões raster-vetor

---

# 7.11 Conversões raster-vetor

## Rasterização de pontos

```r
rc_spr_rast &lt;- raster::rasterize(x = rc_spr, y = ra_rc_agg_mean, field = 1, fun = "count")
rc_spr_rast
```

---

# 7.11 Conversões raster-vetor

## Rasterização de pontos

```r
# plot
plot(rc_spr_rast)
plot(rc_spr$geometry, pch = 20, cex = .5, col = adjustcolor("black", .5), add = TRUE)
```

---

# 7.11 Conversões raster-vetor

## Rasterização de linhas

```r
# import lines
rc_riv &lt;- sf::st_read(here::here("03_dados", "vetor", "SP_3543907_RIOS_SIMPLES.shp"), quiet = TRUE) %&gt;% 
  sf::st_transform(crs = 4326)
rc_riv
```

---

# 7.11 Conversões raster-vetor

## Rasterização de linhas

```r
rc_riv_rast &lt;- raster::rasterize(x = rc_riv, y = ra_rc_agg_mean)
rc_riv_rast
```

---

# 7.11 Conversões raster-vetor

## Rasterização de linhas

```r
# plot
plot(rc_riv_rast)
plot(rc_riv$geometry, pch = 20, cex = .5, col = adjustcolor("black", .5), add = TRUE)
```

---

# 7.11 Conversões raster-vetor

## Rasterização de polígonos

```r
# import polygons
rc_use &lt;- sf::st_read(here::here("03_dados", "vetor", "SP_3543907_USO.shp"), quiet = TRUE) %&gt;% 
  dplyr::mutate(CLASSE_USO = as.factor(CLASSE_USO)) %&gt;% 
    sf::st_transform(crs = 4326)
```

---

# 7.11 Conversões raster-vetor

## Rasterização de polígonos

```r
rc_use_rast &lt;- raster::rasterize(x = rc_use, y = ra_rc_agg_mean, field = "CLASSE_USO")
rc_use_rast
```

---

# 7.11 Conversões raster-vetor

## Rasterização de polígonos

```r
# plot
plot(rc_use_rast)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.11 Conversões raster-vetor

## Rasterização de polígonos

### Fasterize

```r
# pacote
# install.packages("fasterize")
library(fasterize)
```

---

# 7.11 Conversões raster-vetor

## Rasterização de polígonos

### Fasterize

```r
ra_use_rc_fast &lt;- fasterize::fasterize(sf = rc_use, raster = ra_rc_agg_mean, field = "CLASSE_USO")
ra_use_rc_fast
```

---

# 7.11 Conversões raster-vetor

## Rasterização de polígonos

### Fasterize

```r
# plot
plot(ra_use_rc_fast)
plot(rc_2019$geom, add = TRUE)
```

---

# 7.12 Exportar dados matriciais

## Exportar raster

```r
raster::writeRaster(ra_mask_utm, "ra_mask_utm.tif")
```

---

# 7.12 Exportar dados matriciais

## Exportar stack ou brick

```r
raster::writeRaster(ra_mask_utm, "ra_mask_utm.tif")
```

---

class: inverse, middle, center

# Dúvidas?

---

class: clear, middle

## Maurício Vancine

&lt;br&gt;

Contatos:

&lt;br&gt;
<i class="fas  fa-envelope " style="color:#0000ee;"></i> [mauricio.vancine@gmail.com]()
&lt;br&gt;
<i class="fab  fa-twitter " style="color:#0000ee;"></i> [@mauriciovancine](https://twitter.com/mauriciovancine)
&lt;br&gt;
<i class="fab  fa-github " style="color:#0000ee;"></i> [mauriciovancine](https://mauriciovancine.netlify.com/)
&lt;br&gt;
<i class="fas  fa-link " style="color:#0000ee;"></i> [mauriciovancine.netlify.com](https://mauriciovancine.netlify.com/)

Slides criados via pacote [xaringan](https://github.com/yihui/xaringan) e tema [Metropolis](https://github.com/pat-s/xaringan-metropolis)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "rainbow",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
